<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Pro Dashboard</title>

    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .btn-custom-primary { background-color: #4e73df; color: white; }
        .btn-custom-danger { background-color: #e74a3b; color: white; }
        .prop-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .status-badge { font-size: 0.75rem; padding: 5px 10px; border-radius: 20px; }
        .scrollable-list { max-height: 500px; overflow-y: auto; }
        /* Toast notification */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>

<body>

<!-- TOAST NOTIFICATION -->
<div class="toast-container" id="toastContainer"></div>

<div class="container-fluid py-4 px-4">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary fw-bold m-0">
                <i class="fa-solid fa-building-user"></i> RENTAL PRO <span class="badge bg-warning text-dark fs-6">No-Login Mode</span>
            </h3>
            <small class="text-muted">H·ªá th·ªëng qu·∫£n l√Ω cho thu√™ to√†n nƒÉng</small>
        </div>

        <div class="d-flex gap-3">
             <div class="card px-4 py-2 bg-white border-start border-4 border-success">
                <small class="text-muted fw-bold">T·ªîNG DOANH THU</small>
                <h4 class="m-0 fw-bold text-success" id="totalRevenue">0 ƒë</h4>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- C·ªòT 1: QU·∫¢N L√ù T√ÄI S·∫¢N -->
        <div class="col-lg-3 col-md-6">
            <div class="card p-3 border-top border-4 border-primary h-100">
                <h6 class="fw-bold text-primary mb-3"><i class="fa-solid fa-plus-circle"></i> TH√äM T√ÄI S·∫¢N M·ªöI</h6>

                <form id="propertyForm">
                    <div class="mb-2">
                        <label class="small fw-bold text-muted">Lo·∫°i t√†i s·∫£n</label>
                        <select class="form-select" id="propCategory">
                            <option value="real_estate">üè† B·∫•t ƒë·ªông s·∫£n</option>
                            <option value="vehicle">üöó Xe c·ªô</option>
                            <option value="item">üì¶ ƒê·ªì d√πng & Thi·∫øt b·ªã</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <input class="form-control" id="propName" required placeholder="T√™n (VD: CƒÉn h·ªô P102, Xe Mazda 3)">
                    </div>

                    <div class="mb-2">
                        <input class="form-control" id="propAddress" required placeholder="ƒê·ªãa ch·ªâ / Bi·ªÉn s·ªë">
                    </div>

                    <div class="mb-2">
                        <input type="number" class="form-control" id="propPrice" required placeholder="Gi√° thu√™ (VNƒê)">
                    </div>

                    <div class="mb-3">
                        <input class="form-control" id="propImage" placeholder="Link ·∫£nh (URL) - Kh√¥ng b·∫Øt bu·ªôc">
                    </div>

                    <button class="btn btn-primary w-100 fw-bold" type="submit">
                        <i class="fa-solid fa-save"></i> L∆ØU T√ÄI S·∫¢N
                    </button>
                </form>

                <hr class="my-3">
                <div class="alert alert-info small mb-0">
                    <i class="fa-solid fa-info-circle"></i> <strong>M·∫πo:</strong> Nh·∫≠p URL ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã thumbnail ƒë·∫πp m·∫Øt h∆°n.
                </div>
            </div>
        </div>

        <!-- C·ªòT 2: DANH S√ÅCH T√ÄI S·∫¢N -->
        <div class="col-lg-5 col-md-6">
            <div class="card p-0 h-100">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-white rounded-top">
                    <h6 class="fw-bold m-0"><i class="fa-solid fa-list"></i> KHO T√ÄI S·∫¢N</h6>
                    <select class="form-select form-select-sm w-auto" id="filterCategory" onchange="loadProperties()">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="real_estate">Nh√† ƒë·∫•t</option>
                        <option value="vehicle">Xe c·ªô</option>
                        <option value="item">ƒê·ªì d√πng</option>
                    </select>
                </div>

                <div class="table-responsive scrollable-list">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 60px;">·∫¢nh</th>
                            <th>Th√¥ng tin</th>
                            <th class="text-end">Gi√°/Ng√†y</th>
                            <th class="text-center">TT</th>
                            <th class="text-center">#</th>
                        </tr>
                        </thead>
                        <tbody id="propertyList">
                            <!-- JS will render here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- C·ªòT 3: H·ª¢P ƒê·ªíNG & THANH TO√ÅN -->
        <div class="col-lg-4 col-md-12">
            <!-- Form t·∫°o H·ª£p ƒê·ªìng -->
            <div class="card p-3 mb-3 border-top border-4 border-danger">
                <h6 class="fw-bold text-danger mb-3"><i class="fa-solid fa-file-signature"></i> L·∫¨P H·ª¢P ƒê·ªíNG M·ªöI</h6>

                <form id="contractForm">
                    <div class="mb-2">
                        <select class="form-select" id="contractPropId" required onchange="calculateTotal()">
                            <option value="">-- Ch·ªçn t√†i s·∫£n (ƒêang r·∫£nh) --</option>
                        </select>
                    </div>

                    <div class="mb-2">
                        <input type="email" class="form-control" id="contractEmail" required placeholder="Email kh√°ch thu√™ (T·ª± t·∫°o User n·∫øu m·ªõi)">
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="small text-muted fw-bold">B·∫Øt ƒë·∫ßu</label>
                            <input type="date" class="form-control" id="startDate" required onchange="calculateTotal()">
                        </div>
                        <div class="col-6">
                            <label class="small text-muted fw-bold">K·∫øt th√∫c</label>
                            <input type="date" class="form-control" id="endDate" required onchange="calculateTotal()">
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-2 border">
                        <span class="small fw-bold text-muted">T·∫°m t√≠nh:</span>
                        <strong id="previewTotal" class="text-danger fs-5">0 ƒë</strong>
                    </div>

                    <div class="row g-2">
                         <div class="col-6">
                             <input type="number" class="form-control" id="deposit" placeholder="Ti·ªÅn c·ªçc">
                         </div>
                         <div class="col-6">
                             <button class="btn btn-danger w-100 fw-bold" type="submit">
                                <i class="fa-solid fa-check"></i> K√ù Hƒê
                            </button>
                         </div>
                    </div>
                </form>
            </div>

            <!-- Danh s√°ch H·ª£p ƒê·ªìng -->
            <div class="card h-100">
                <div class="p-3 border-bottom bg-white rounded-top">
                    <h6 class="fw-bold m-0"><i class="fa-solid fa-file-invoice-dollar"></i> DANH S√ÅCH H·ª¢P ƒê·ªíNG</h6>
                </div>
                <div class="list-group list-group-flush scrollable-list" id="contractList">
                    <!-- JS Render -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL THANH TO√ÅN -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fa-solid fa-money-bill-wave"></i> Qu·∫£n l√Ω thanh to√°n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="payContractId">
                <div class="d-flex justify-content-between mb-3">
                    <strong>M√£ H·ª£p ƒê·ªìng: <span id="modalContractIdDisplay"></span></strong>
                    <span class="badge bg-warning text-dark" id="modalContractStatus">Active</span>
                </div>

                <!-- Form ƒë√≥ng ti·ªÅn -->
                <form id="paymentForm" class="mb-4 p-3 bg-light rounded border">
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="number" class="form-control" id="payAmount" placeholder="S·ªë ti·ªÅn thu" required>
                        </div>
                        <div class="col-6">
                            <input type="date" class="form-control" id="payDate" required>
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control" id="payNote" placeholder="Ghi ch√∫ (VD: Thu ti·ªÅn th√°ng 1)">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success w-100 fw-bold">
                                <i class="fa-solid fa-plus"></i> TH√äM THANH TO√ÅN
                            </button>
                        </div>
                    </div>
                </form>

                <h6 class="fw-bold border-bottom pb-2">L·ªãch s·ª≠ giao d·ªãch</h6>
                <table class="table table-sm table-striped">
                    <thead>
                        <tr class="text-muted small">
                            <th>Ng√†y</th>
                            <th>N·ªôi dung</th>
                            <th class="text-end">S·ªë ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ============================================================
    // C·∫§U H√åNH & UTILS
    // ============================================================
    const API_URL = "http://localhost:8000";
    let propertiesData = [];
    
    // Format ti·ªÅn t·ªá VNƒê
    const fmtMoney = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

    // Toast th√¥ng b√°o
    function showToast(message, type = 'success') {
        const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
        const toastHtml = `
            <div class="toast align-items-center text-white ${bgClass} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
        const container = document.getElementById('toastContainer');
        const div = document.createElement('div');
        div.innerHTML = toastHtml;
        container.appendChild(div.firstElementChild);
        setTimeout(() => container.firstChild?.remove(), 5000);
    }

    // ============================================================
    // 1. QU·∫¢N L√ù T√ÄI S·∫¢N
    // ============================================================
    async function loadProperties() {
        try {
            const filterCat = document.getElementById("filterCategory").value;
            const res = await fetch(`${API_URL}/properties/`);
            if (!res.ok) {
                 showToast("L·ªói k·∫øt n·ªëi Backend (Check xem ƒë√£ ch·∫°y main.py ch∆∞a?)", "error");
                 return;
            }
            const data = await res.json();
            propertiesData = data; // Cache data

            const listBody = document.getElementById("propertyList");
            const selectBox = document.getElementById("contractPropId");
            
            listBody.innerHTML = "";
            selectBox.innerHTML = `<option value="">-- Ch·ªçn t√†i s·∫£n --</option>`;

            const filteredData = data.filter(p => !filterCat || p.category === filterCat);
            
            if (filteredData.length === 0) {
                listBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Ch∆∞a c√≥ t√†i s·∫£n n√†o</td></tr>`;
            }

            filteredData.forEach(prop => {
                // Icon ho·∫∑c ·∫¢nh
                let imgHtml = '';
                if (prop.image_url) {
                    imgHtml = `<img src="${prop.image_url}" class="prop-img" onerror="this.src='https://placehold.co/50?text=Error'">`;
                } else {
                    const icon = prop.category === "vehicle" ? "üöó" : prop.category === "item" ? "üì¶" : "üè†";
                    imgHtml = `<div class="d-flex align-items-center justify-content-center bg-light rounded fs-4" style="width:50px; height:50px;">${icon}</div>`;
                }

                const badge = prop.status === "available"
                    ? `<span class="badge bg-success status-badge">S·∫µn s√†ng</span>`
                    : `<span class="badge bg-secondary status-badge">ƒêang thu√™</span>`;

                listBody.innerHTML += `
                    <tr>
                        <td>${imgHtml}</td>
                        <td>
                            <div class="fw-bold text-dark">${prop.name}</div>
                            <div class="small text-muted text-truncate" style="max-width: 150px;">${prop.address}</div>
                        </td>
                        <td class="text-end fw-bold text-primary small">${fmtMoney(prop.price)}</td>
                        <td class="text-center">${badge}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteProperty(${prop.id})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                // Add to Select Box if Available
                if (prop.status === "available") {
                    selectBox.innerHTML += `
                        <option value="${prop.id}" data-price="${prop.price}">
                            ${prop.name} - ${fmtMoney(prop.price)}/ng√†y
                        </option>
                    `;
                }
            });

        } catch (err) {
            console.error(err);
            showToast("L·ªói t·∫£i d·ªØ li·ªáu: " + err.message, "error");
        }
    }

    // Th√™m T√†i S·∫£n
    document.getElementById("propertyForm").addEventListener("submit", async e => {
        e.preventDefault();
        const payload = {
            name: document.getElementById("propName").value,
            address: document.getElementById("propAddress").value,
            price: Number(document.getElementById("propPrice").value),
            category: document.getElementById("propCategory").value,
            image_url: document.getElementById("propImage").value || null,
            owner_id: 1
        };

        try {
            const res = await fetch(`${API_URL}/properties/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                showToast("ƒê√£ th√™m t√†i s·∫£n m·ªõi!");
                e.target.reset();
                loadProperties();
            } else {
                // ƒê·ªçc l·ªói chi ti·∫øt t·ª´ Backend tr·∫£ v·ªÅ
                const errData = await res.json().catch(() => ({})); 
                const errMsg = errData.detail || res.statusText || "L·ªói kh√¥ng x√°c ƒë·ªãnh";
                console.error("L·ªói:", errMsg);
                
                let friendlyMsg = "L·ªói th√™m t√†i s·∫£n: " + errMsg;
                if(res.status === 500) {
                    friendlyMsg = "L·ªói Server (500). C√≥ th·ªÉ do ch∆∞a ch·∫°y reset_db.py?";
                }
                
                showToast(friendlyMsg, "error");
            }
        } catch (err) { 
            console.error(err);
            showToast("L·ªói k·∫øt n·ªëi: " + err.message, "error");
        }
    });

    // X√≥a T√†i S·∫£n
    async function deleteProperty(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i s·∫£n n√†y?")) return;
        try {
            const res = await fetch(`${API_URL}/properties/${id}`, { method: "DELETE" });
            if (res.ok) {
                showToast("ƒê√£ x√≥a t√†i s·∫£n");
                loadProperties();
            } else {
                showToast("Kh√¥ng th·ªÉ x√≥a (C√≥ th·ªÉ ƒëang c√≥ Hƒê)", "error");
            }
        } catch (err) { console.error(err); }
    }

    // ============================================================
    // 2. LOGIC T√çNH TI·ªÄN H·ª¢P ƒê·ªíNG
    // ============================================================
    function calculateTotal() {
        const propSelect = document.getElementById("contractPropId");
        const option = propSelect.options[propSelect.selectedIndex];
        const price = Number(option?.dataset.price || 0);

        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;
        const display = document.getElementById("previewTotal");

        if (!price || !start || !end) {
            display.innerText = "0 ƒë";
            return;
        }

        const startDate = new Date(start);
        const endDate = new Date(end);
        
        // T√≠nh s·ªë ng√†y ch√™nh l·ªách
        const diffTime = endDate - startDate;
        const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (days <= 0) {
            display.innerText = "Ng√†y kh√¥ng h·ª£p l·ªá";
            return;
        }

        const total = days * price;
        display.innerText = fmtMoney(total);
    }

    // ============================================================
    // 3. QU·∫¢N L√ù H·ª¢P ƒê·ªíNG
    // ============================================================
    async function loadContracts() {
        try {
            const res = await fetch(`${API_URL}/contracts/`);
            if(!res.ok) return; // Silent fail if API down
            const data = await res.json();
            const list = document.getElementById("contractList");
            list.innerHTML = "";
            let totalRevenue = 0;

            if (data.length === 0) {
                 list.innerHTML = `<div class="text-center text-muted p-4">Ch∆∞a c√≥ h·ª£p ƒë·ªìng n√†o</div>`;
                 document.getElementById("totalRevenue").innerText = "0 ƒë";
                 return;
            }

            for (const c of data) {
                // Get Payment Info
                const payments = await fetch(`${API_URL}/contracts/${c.id}/payments`).then(r => r.json()).catch(() => []);
                const paid = payments.reduce((s, p) => s + p.amount, 0);
                totalRevenue += paid;

                // X√°c ƒë·ªãnh tr·∫°ng th√°i thanh to√°n
                let progressClass = "bg-warning"; 
                if (paid >= c.total_price) progressClass = "bg-success";
                
                const percent = Math.min(100, (paid / c.total_price) * 100);

                list.innerHTML += `
                    <div class="list-group-item list-group-item-action p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-primary">Hƒê #${c.id}</strong>
                                <span class="text-muted small mx-1">|</span>
                                <small class="fw-bold">${c.start_date} ‚ûù ${c.end_date}</small>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light py-0" data-bs-toggle="dropdown">‚ãÆ</button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="${API_URL}/contracts/${c.id}/download" target="_blank"><i class="fa-solid fa-download"></i> T·∫£i Hƒê</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteContract(${c.id})"><i class="fa-solid fa-trash"></i> H·ªßy Hƒê</a></li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between small mb-2">
                            <span>T·ªïng: <strong>${fmtMoney(c.total_price)}</strong></span>
                            <span class="text-success">ƒê√£ thu: <strong>${fmtMoney(paid)}</strong></span>
                        </div>

                        <div class="progress" style="height: 6px;" title="Ti·∫øn ƒë·ªô thanh to√°n">
                            <div class="progress-bar ${progressClass}" style="width: ${percent}%"></div>
                        </div>

                        <button class="btn btn-sm btn-outline-success w-100 mt-2 fw-bold" onclick="openPaymentModal(${c.id}, '${c.status}')">
                            <i class="fa-solid fa-wallet"></i> N·ªôp ti·ªÅn
                        </button>
                    </div>
                `;
            }

            document.getElementById("totalRevenue").innerText = fmtMoney(totalRevenue);

        } catch (err) { console.error(err); }
    }

    // T·∫°o H·ª£p ƒê·ªìng
    document.getElementById("contractForm").addEventListener("submit", async e => {
        e.preventDefault();
        const payload = {
            property_id: Number(document.getElementById("contractPropId").value),
            tenant_email: document.getElementById("contractEmail").value,
            start_date: document.getElementById("startDate").value,
            end_date: document.getElementById("endDate").value,
            deposit: Number(document.getElementById("deposit").value) || 0,
            rental_type: "daily"
        };

        try {
            const res = await fetch(`${API_URL}/contracts/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                showToast("ƒê√£ k√Ω h·ª£p ƒë·ªìng th√†nh c√¥ng!");
                e.target.reset();
                document.getElementById("previewTotal").innerText = "0 ƒë";
                loadProperties(); // Refresh ƒë·ªÉ update status t√†i s·∫£n
                loadContracts();
            } else {
                const err = await res.json().catch(() => ({}));
                showToast("L·ªói: " + (err.detail || res.statusText), "error");
            }
        } catch (err) { console.error(err); showToast("L·ªói k·∫øt n·ªëi", "error"); }
    });

    // X√≥a H·ª£p ƒê·ªìng
    async function deleteContract(id) {
        if (!confirm("H·ªßy h·ª£p ƒë·ªìng s·∫Ω tr·∫£ l·∫°i tr·∫°ng th√°i 'S·∫µn s√†ng' cho t√†i s·∫£n. Ti·∫øp t·ª•c?")) return;
        try {
            const res = await fetch(`${API_URL}/contracts/${id}`, { method: "DELETE" });
            if (res.ok) {
                showToast("ƒê√£ h·ªßy h·ª£p ƒë·ªìng");
                loadContracts();
                loadProperties();
            }
        } catch (err) { console.error(err); }
    }

    // ============================================================
    // 4. THANH TO√ÅN
    // ============================================================
    const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));

    async function openPaymentModal(cid, status) {
        document.getElementById("modalContractIdDisplay").innerText = "#" + cid;
        document.getElementById("payContractId").value = cid;
        document.getElementById("modalContractStatus").innerText = status || "Active";
        document.getElementById("payDate").valueAsDate = new Date(); // Default today

        // Load History
        const tbody = document.getElementById("paymentHistoryList");
        tbody.innerHTML = "<tr><td colspan='3' class='text-center'><small>ƒêang t·∫£i...</small></td></tr>";
        
        try {
            const res = await fetch(`${API_URL}/contracts/${cid}/payments`);
            const payments = await res.json();
            
            tbody.innerHTML = "";
            if (payments.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3' class='text-center text-muted'><small>Ch∆∞a c√≥ giao d·ªãch</small></td></tr>";
            }
            
            payments.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.payment_date}</td>
                        <td>${p.note || "-"}</td>
                        <td class="text-end text-success fw-bold">+${fmtMoney(p.amount)}</td>
                    </tr>
                `;
            });
        } catch (e) {
            tbody.innerHTML = "<tr><td colspan='3' class='text-center text-danger'>L·ªói t·∫£i l·ªãch s·ª≠</td></tr>";
        }

        paymentModal.show();
    }

    // Submit Thanh To√°n
    document.getElementById("paymentForm").addEventListener("submit", async e => {
        e.preventDefault();
        const cid = document.getElementById("payContractId").value;
        
        const payload = {
            contract_id: Number(cid),
            amount: Number(document.getElementById("payAmount").value),
            payment_date: document.getElementById("payDate").value,
            note: document.getElementById("payNote").value
        };

        try {
            const res = await fetch(`${API_URL}/payments/`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            
            if (res.ok) {
                showToast("ƒê√£ ghi nh·∫≠n thanh to√°n");
                document.getElementById("payAmount").value = "";
                document.getElementById("payNote").value = "";
                openPaymentModal(cid); // Reload history
                loadContracts(); // Update progress bar
            } else {
                 showToast("L·ªói thanh to√°n", "error");
            }
        } catch (err) { console.error(err); }
    });

    // INIT APP
    window.onload = () => {
        loadProperties();
        loadContracts();
    };
</script>

</body>
</html>